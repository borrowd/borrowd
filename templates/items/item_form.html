{% extends "items/layout.html" %}

{% comment %}
    This template is used for both creating and editing.
    Checking `view.object.pk` is strangely the best way to check
    if we are creating or editing.
{% endcomment %}
{% block head_title %}{% if not view.object.pk %}Create{% else %}Edit{% endif %} Item{% endblock %}

{% block items_content %}
<div class="w-full">
    {% include "components/page_header.html" with title=page_title %}
    <form method="post" enctype="multipart/form-data" class="flex flex-col gap-4" onsubmit="this.querySelector('button[type=submit]').disabled = true;">
        {% csrf_token %}
        {% for field in form %}
        <div class="fieldset w-full">
            <label class="label">
                <span class="label-text ">{{ field.label }}</span>
                {% if field.name == "trust_level_required" %}
                    <a href="javascript:void(0)" onclick="showModal('trust-level-info-modal')" class="label-text-alt text-blue-600 hover:text-blue-800 underline ml-2">What is this?</a>
                {% endif %}
            </label>
            {% if field.name == "categories" %}
                <!--
                    Category field

                    1. Alpine.js manages selected categories via the selectedIds array
                    2. A reactive <template x-for> generates hidden <input> fields
                       for each selected ID, so the form always submits the current state
                    3. When user clicks "Save item", browser submits the form with
                       POST data like: categories=3&categories=7
                    4. Django's ItemForm processes this (borrowd_items/forms.py)

                -->
                <div x-data="{
                    /*
                     * Alpine UI state: which category IDs are currently selected.
                     * Pre-populated from Django form's current value on page load.
                     * (Empty on create, has values on edit.)
                     */
                    selectedIds: [{% for val in field.value %}{% if val %}'{{ val }}'{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}],
                    categories: [{% for choice in field.field.choices %}{ id: '{{ choice.0 }}', name: '{{ choice.1 }}' }{% if not forloop.last %},{% endif %}{% endfor %}],

                    /* Toggle a category by id: add if not selected, remove if already selected. */
                    toggle(id) {
                        const idx = this.selectedIds.indexOf(id);
                        if (idx === -1) { this.selectedIds.push(id); }
                        else { this.selectedIds.splice(idx, 1); }
                    },

                    isSelected(id) {
                        return this.selectedIds.includes(id);
                    },

                    /*
                     * Display text for the trigger button.
                     * No selection: 'Select an item category'
                     * One selected: full category name
                     * Multiple: first name truncated (12 chars) + '... + N more'
                     *   e.g.: 'Home & Kitch... + 3 more'
                     */
                    get buttonText() {
                        if (this.selectedIds.length === 0) return 'Select an item category';
                        const firstName = this.categories.find(c => c.id === this.selectedIds[0])?.name || '';
                        if (this.selectedIds.length === 1) return firstName;
                        const truncated = firstName.length > 12 ? firstName.slice(0, 12) + '...' : firstName;
                        return truncated + ' + ' + (this.selectedIds.length - 1) + ' more';
                    },

                    clearFilters() {
                        this.selectedIds = [];
                        closeModal('item-category-modal');
                    },

                    applyFilters() {
                        closeModal('item-category-modal');
                    }
                }">
                    <!-- Trigger button: opens the category selection modal -->
                    <button type="button"
                        @click="showModal('item-category-modal')"
                        class="select select-bordered w-full text-left flex items-center"
                        x-text="buttonText">
                    </button>

                    <!--
                        Hidden inputs for selected categories.
                        Alpine reactively generates one <input> per selected ID,
                        so the form always submits the current selectedIds state.
                    -->
                    <template x-for="id in selectedIds" :key="id">
                        <input type="hidden" name="{{ field.html_name }}" :value="id">
                    </template>

                    {% include "components/items/category_filter_modal.html" with modal_id="item-category-modal" confirm_button_text="Filter categories" %}
                </div>
            {% else %}
                {{ field }}
            {% endif %}
            {% if field.errors %}
                <label class="label">
                    <span class="label-text-alt text-error">{{ field.errors }}</span>
                </label>
            {% endif %}
            {% if field.name == "image" %}
                <label class="label">
                    <span class="label-text-alt text-base-content/60">Max size 5MB</span>
                </label>
            {% endif %}
        </div>
        {% endfor %}

        {% if view.object.pk %}
            <b>Photos:</b>
            {% if view.object.photos.all %}
                <c-gallery>
                {% for photo in view.object.photos.all %}
                    <div>
                        <c-photo src="{{ photo.image.url }}"
                            alt="{{ view.object.name }} Photo {{ forloop.counter }}" />
                        <div class="p-1">
                            <c-button-nav url="{% url 'itemphoto-delete' view.object.pk photo.pk %}" class="btn btn-link">
                                Delete
                            </c-button-nav>
                        </div>
                    </div>
                {% endfor %}
                </c-gallery>
            {% else %}
                <div class="mb-2">No photos</div>
            {% endif %}
            {% if view.object.photos.count < 5 %}
                <c-button-nav url="{% url 'itemphoto-create' form.instance.pk %}" class="btn btn-sm">Add Photo</c-button-nav>
            {% else %}
                <div class="text-gray-500 italic">Photo limit (5) reached. Delete a photo if you want to add another.</div>
            {% endif %}

        {% endif %}

        <div class="mt-4">
            <c-button type="submit" class="btn btn-primary mr-2">Save item</c-button>
            {% if form.instance.pk %}
                <c-button-nav url="{% url 'item-detail' form.instance.pk %}" class="btn">
                    Cancel
                </c-button-nav>
                <c-button-nav url="{% url 'item-delete' form.instance.pk %}" class="btn btn-link">
                    Delete
                </c-button-nav>
            {% endif %}
        </div>
    </form>
</div>

{% include "components/modal.html" with modal_id="trust-level-info-modal" modal_title="Group trust levels" modal_size="full" cancel_button="Got it" modal_content="<div class='text-left'><p class='mb-4'>At the heart of Borrow'd is trust. Each group you join gets a trust level (High or Standard), which determines what kinds of items they can request from you. For example:</p><div class='mb-4'><p class='font-bold mb-2'><span class='text-borrowd-plum-600'>High trust:</span> Super Best Friends</p><p>If you mark an item as High trust, it can only be seen and borrowed by people in groups you’ve marked as High trust. Use this for items that are valuable, fragile, or personal — like electronics, specialized tools, or anything you’d only lend to people you know well. Your trust settings are private — no one else can see which groups you’ve marked as High trust.</p></div><div class='mb-4'><p class='font-bold mb-2'><span class='text-indigo-600'>Standard trust:</span> Neighborhood Community</p><p>Items marked as “Standard” trust are visible to people in the groups you’ve joined. Use this for everyday items you’re comfortable sharing more widely.</p></div></div>" %}
{% endblock %}
