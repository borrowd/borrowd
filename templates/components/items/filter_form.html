<!-- Item Filter Form Component -->
<form method="get" class="flex flex-col space-y-4"
    x-data="{
        /*
        * Alpine UI state: which category IDs are currently selected.
        * Pre-populated from Django form's current value on page load.
        * (Empty on create, has values on edit.)
        */
        selectedIds: [{% for val in filter.form.categories.value %}'{{ val }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        categories: [{% for choice in filter.form.categories.field.choices %}{ id: '{{ choice.0 }}', name: '{{ choice.1 }}' }{% if not forloop.last %},{% endif %}{% endfor %}],

        /* Toggle a category by id: add if not selected, remove if already selected. */
        toggle(id) {
            const idx = this.selectedIds.indexOf(id);
            if (idx === -1) { this.selectedIds.push(id); }
            else { this.selectedIds.splice(idx, 1); }
        },

        isSelected(id) {
            return this.selectedIds.includes(id);
        },

         /*
        * Display text for the trigger button.
        * No selection: 'Select an item category'
        * One selected: full category name
        * Multiple: first name truncated (12 chars) + '... + N more'
        *   e.g.: 'Home & Kitch... + 3 more'
        */
        get buttonText() {
            if (this.selectedIds.length === 0) return 'Filter by category';
            const firstName = this.categories.find(c => c.id === this.selectedIds[0])?.name || '';
            if (this.selectedIds.length === 1) return firstName;
            const truncated = firstName.length > 12 ? firstName.slice(0, 12) + '...' : firstName;
            return truncated + ' + ' + (this.selectedIds.length - 1) + ' more';
        },

        /*
         * Propagate Alpine's selectedIds state to the hidden select element.
         * This ensures Django's FilterSet receives the correct category values
         * when the form is submitted via GET.
         */
        writeSelectedIdsToHiddenSelect() {
            const select = this.$refs.hiddenSelect;
            for (const opt of select.options) {
                opt.selected = this.selectedIds.includes(opt.value);
            }
        },

        /* Clear all selections, sync to hidden select, close modal, and submit form. */
        clear() {
            this.selectedIds = [];
            this.writeSelectedIdsToHiddenSelect();
            closeModal('category-filter-modal');
            this.$el.closest('form').submit();
        },

        /* Sync selections to hidden select, close modal, and submit form to apply filters. */
        confirm() {
            this.writeSelectedIdsToHiddenSelect();
            closeModal('category-filter-modal');
            this.$el.closest('form').submit();
        }
    }"
>
    <!-- Search bar and button -->
    <div class="flex gap-4 items-start">
        <input type="text" name="{{ filter.form.search.html_name }}" id="{{ filter.form.search.id_for_label }}"
               class="input input-bordered w-full"
               value="{{ filter.form.search.value|default:'' }}"
               placeholder="Search for an item">
        <input type="submit" value="Search" class="btn btn-primary">
    </div>

    <!-- Category filter trigger badge -->
    <div class="flex flex-wrap gap-4 items-center">
        <button type="button" @click="showModal('category-filter-modal')"
            :class="selectedIds.length > 0
                ? 'badge badge-neutral font-medium text-sm leading-6 cursor-pointer px-3 py-1 gap-2'
                : 'badge badge-outline font-medium text-sm leading-6 cursor-pointer px-3 py-1 gap-2'">
            <!-- Heroicons: adjustments-horizontal -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="size-5">
                <path d="M17 2.75a.75.75 0 0 0-1.5 0v5.5a.75.75 0 0 0 1.5 0v-5.5ZM17 15.75a.75.75 0 0 0-1.5 0v1.5a.75.75 0 0 0 1.5 0v-1.5ZM3.75 15a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75ZM4.5 2.75a.75.75 0 0 0-1.5 0v5.5a.75.75 0 0 0 1.5 0v-5.5ZM10 11a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0v-5.5A.75.75 0 0 1 10 11ZM10.75 2.75a.75.75 0 0 0-1.5 0v1.5a.75.75 0 0 0 1.5 0v-1.5ZM10 6a2 2 0 1 0 0 4 2 2 0 0 0 0-4ZM3.75 10a2 2 0 1 0 0 4 2 2 0 0 0 0-4ZM16.25 10a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z" />
            </svg>
            <span x-text="buttonText"></span>
        </button>
        <!-- Inline clear button, only visible when categories are selected -->
        <button type="button"
            x-show="selectedIds.length > 0"
            x-cloak
            @click="selectedIds = []; writeSelectedIdsToHiddenSelect(); $el.closest('form').submit();"
            class="btn btn-outline btn-primary btn-xs font-semibold">
            Clear
        </button>
    </div>

    <!--
        Visually hidden select element.
        Alpine syncs selected category values here so Django's
        FilterSet receives them on form GET submit.
    -->
    <select x-ref="hiddenSelect"
            name="{{ filter.form.categories.html_name }}"
            id="{{ filter.form.categories.id_for_label }}"
            multiple
            class="hidden">
        {% for choice in filter.form.categories.field.choices %}
            {% with choice_value=choice.0|stringformat:"s" %}
            <option value="{{ choice_value }}" {% if filter.form.categories.value and choice_value in filter.form.categories.value %}selected{% endif %}>
                {{ choice.1 }}
            </option>
            {% endwith %}
        {% endfor %}
    </select>

    {% include "components/items/category_filter_modal.html" with modal_id="category-filter-modal" confirm_button_text="Update search" %}
</form>
