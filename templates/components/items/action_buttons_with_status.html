<!--
    Originally these were properly separate components but when apart Alpine wouldn't properly pick up the htmx swap so styling would lag behind.
  -->
<div id="action-status-container" class="flex flex-col items-center my-2 gap-2">
    <div
        x-data="itemActionStatus(
                [{% for action in item_actions %}
                    '{{ action.name }}'
                    {% if not forloop.last %},
                    {% endif %}
                {% endfor %}],
                {{ user.pk }},
                {{ item.owner.pk }},
                {{ item.status }},
                {% if current_borrower %}
                    { id: {{ current_borrower.pk }}, username: '{{ current_borrower.username }}' }
                {% else %}
                    null
                {% endif %},
                {% if requesting_user %}
                    { id: {{ requesting_user.pk }}, username: '{{ requesting_user.username }}' }
                {% else %}
                    null
                {% endif %}
            )"
        class="flex flex-col items-center gap-2">

        <!-- Status Box -->
        <div class="my-4 p-3 border rounded-lg" :class="statusInfo.classes">
            <div class="flex items-center">
                <!-- TODO: design team info icon -->
                <svg class="w-10 h-10 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                <span x-text="statusInfo.text"></span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-wrap items-center space-x-2">
            {% for action in item_actions %}
                {% if action.name == 'ACCEPT_REQUEST' or action.name == 'REJECT_REQUEST' %}
                    <button
                        type="button"
                        hx-post="{% url 'item-borrow' item.pk %}"
                        hx-vals='{"action": "{{ action.name }}"}'
                        hx-trigger="click"
                        hx-swap="innerHTML"
                        hx-target="#action-status-container"
                        class="inline-block w-fit text-white font-medium py-2 px-4 rounded
                        {% if action.name == 'ACCEPT_REQUEST' %}bg-green-600 hover:bg-green-700
                        {% elif action.name == 'REJECT_REQUEST' %}bg-red-600 hover:bg-red-700
                        {% endif %}"
                    >
                        {{ action.label }}
                    </button>
                {% else %}
                    <button
                        type="button"
                        hx-post="{% url 'item-borrow' item.pk %}"
                        hx-vals='{"action": "{{ action.name }}"}'
                        hx-trigger="click"
                        hx-swap="innerHTML"
                        hx-target="#action-status-container"
                        class="inline-block w-fit text-white font-medium py-2 px-4 rounded
                        {% if action.name == 'REQUEST_ITEM' %}bg-orange-600 hover:bg-orange-700
                        {% elif action.name == 'CANCEL_REQUEST' %}bg-red-600 hover:bg-red-700
                        {% else %}bg-blue-600 hover:bg-blue-700
                        {% endif %}"
                    >
                        {{ action.label }}
                    </button>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

<script>
function itemActionStatus(actions, userId, ownerId, itemStatus, currentBorrower, requestingUser) {
    return {
        actions: actions,
        get isOwner() {
            return userId === ownerId;
        },
        get isBorrower() {
            return currentBorrower && userId === currentBorrower.id;
        },
        get statusInfo() {
            const classes = 'bg-blue-50 border-blue-200 text-blue-800';
            let text = 'No actions available';

            // Determine the relevant user's name for status messages
            const requesterName = requestingUser?.username || 'Someone';
            const borrowerName = currentBorrower?.username || 'Borrower';

            // Owner-specific status messages
            if (this.isOwner) {
                if (this.actions.includes('ACCEPT_REQUEST')) {
                    text = `${requesterName} has requested to borrow this item!`;
                } else if (this.actions.includes('MARK_COLLECTED') && this.actions.includes('CANCEL_REQUEST')) {
                    text = `You've accepted ${borrowerName}'s borrow request, please mark the item as Collected when you've given it to them.`;
                } else if (this.actions.includes('CONFIRM_COLLECTED')) {
                    text = `${borrowerName} marked item as collected, confirm you have lent it.`;
                }  else if (this.actions.includes('MARK_RETURNED')) {
                    text = `You are currently lending this item to ${borrowerName}. Mark it as returned when you have received it back.`;
                } else if (this.actions.includes('CONFIRM_RETURNED')) {
                    text = `${borrowerName} marked item as returned, confirm you have received it back.`;
                } else if (itemStatus === 20) { // todo: can we pass these along as a constant from backend
                    text = `You've marked this item as reserved, waiting for ${borrowerName} to confirm collected.`;
                } else if (itemStatus === 30) {
                    text = `Waiting for ${borrowerName} to confirm returned.`;
                } else {
                    text = 'This is your item and it is available for borrowing.';
                }
            } else if (this.isBorrower) { // Deliberately obscuring owner's name here for privacy to reject
                if (this.actions.includes('CANCEL_REQUEST')) {
                    text = 'Owner accepted request, mark Collected when you have received the item.';
                } else if (this.actions.includes('CONFIRM_COLLECTED')) {
                    text = 'Owner marked item as collected, confirm you have received it.';
                } else if (this.actions.includes('MARK_RETURNED')) {
                    text = 'You are currently borrowing this item. Mark it as returned when you have returned it to the owner.';
                } else if (this.actions.includes('CONFIRM_RETURNED')) {
                    text = 'Owner marked item as returned, confirm you have given it back.';
                } else if (this.actions.includes('RETURN_ITEM')) {
                    text = 'Currently borrowed - return when done';
                } else if (this.actions.length === 0 && itemStatus === 20 ) {
                    text = 'You\'re currently borrowing this item!';
                }  else if (this.actions.length === 0 && itemStatus === 30 ) {
                    text = 'Waiting owner confirmation of returned item.';
                } else {
                    text = 'Not available for borrowing';
                }
            } else {
                // Non-owner, non-borrower user
                if (this.actions.length === 1 && this.actions.includes('CANCEL_REQUEST')) {
                    text = 'Requested to borrow, waiting on owner response...';
                }
                else if (this.actions.includes('REQUEST_ITEM')) {
                    text = 'Available to request!';
                } else {
                    text = 'Not available for borrowing';
                }
            }

            return {
                text: text,
                classes: classes
            };
        }
    };
}
</script>
